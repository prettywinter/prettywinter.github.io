---
title: Redis数据库
categories: skill
tags: [Redis, 数据库]
abbrlink: eb52a7b2
---

Redis 是一个 Key-Value 结构的开源（BSD）的非关系型数据库。

<!-- more -->

<!-- @import "[TOC]" {cmd="toc" depthFrom=2 depthTo=6 orderedList=true} -->

<!-- code_chunk_output -->

- [一、了解Redis](#一了解redis)
  - [两种数据持久化方式](#两种数据持久化方式)
    - [RDB（增量模式，存储数据）](#rdb增量模式存储数据)
    - [AOF（全量模式，存储命令和数据）](#aof全量模式存储命令和数据)
- [二、Redis的几种模式](#二redis的几种模式)
  - [伪集群搭建配置文件示例](#伪集群搭建配置文件示例)

<!-- /code_chunk_output -->

## 一、了解Redis

后台启动服务：redis-server --daemonize yes

Redis 是一个开源（BSD 许可）的内存数据结构存储，用作数据库、缓存、消息代理和流引擎。Redis 提供数据结构，例如字符串、散列、列表、集合、排序集合、带范围查询的位图、超日志、地理空间索引和流。Redis 内置复制、Lua 脚本、LRU 驱逐、事务和不同级别的磁盘持久性，并通过Redis Sentinel提供高可用，Redis Cluster 提供自动分区。

您可以原子操作对这些类型附加到字符串；增加哈希值；将元素推入列表；计算集交并、差；或获取排序集中排名最高的成员。

为了达到最佳性能，Redis 使用内存中的数据集。根据您的用例，Redis 可以通过定期将数据集转储到磁盘或将每个命令附加到基于磁盘的日志。如果您只需要一个功能丰富的网络内存缓存，您也可以禁用持久性。

Redis 支持异步复制，具有快速非阻塞同步和自动重新连接以及网络拆分上的部分重新同步。

应用场景举例：缓存系统（“热点”数据：高频读、低频写）、计数器、消息队列系统、排行榜、社交网络和实时系统。

### 两种数据持久化方式

#### RDB（增量模式，存储数据）

优点：是一个紧凑压缩的二进制文件，Redis 加载 RDB 恢复数据远远快于 AOF 的方式。
缺点：由于每次生成 RDB 开销较大，非实时持久化，可能会出现数据丢失（类似于定时任务）。

#### AOF（全量模式，存储命令和数据）

开启后，Redis每执行一个修改数据的命令，都会把这个命令追加到 AOF 文件中。
优点：实时持久化。
缺点：AOF文件体积逐渐变大，需要定期执行重写操作来降低文件体积，加载慢。

> 如果开启了 AOF，在服务重启恢复数据时会以 AOF 为准恢复数据；
> 如果同时开启了 AOF 和 RDB持久化，在服务重启恢复数据时会以 AOF 为准恢复数据；
> 如果只开启了 RDB，在服务重启恢复数据时会以 dump 的方式恢复数据；

Redis 有 16384 个 slot，存储的时候会是使用hash均匀的散列到这些 slot 上。往集群中添加新的物理节点时会重新分配 slot

内存淘汰策略：Redis 的内存淘汰策略是指在Redis的用于缓存的内存不足时，怎么处理需要新写入且需要申请额外空间的数据。

什么是缓存雪崩？解决方案？
原因：一次性加入缓存的数据过多，导致内存过高，从而影响内存的使用导致宕机。
解决方法：
(1)redis集群，通过集群的方式将数据放置。
(2)后端服务降级和限流：当一个接口请求过多，那么就会添加过多数据，可以对服务进行限流，限制访问的数量，这样就可以减少问题的出现。

## 二、Redis的几种模式

1. 主从模式
   redis 主从复制，从节点默认是只读的，当 master 服务挂掉之后，从节点不能代替主节点；主从复制架构只是一个数据的备份。
2. 哨兵模式(建立在主从模式上)
   哨兵的作用，就是监控主、从数据库的状态，当主数据库宕机以后，哨兵会在一定的时间内去判断，然后在从数据库中选举出一个去顶替主数据库，从而实现redis数据的高可用。
3. 集群模式

Redis 的集群模式使用了 CRC16 算法，该算法有以下特点:

1. 对集群模式下的所有key进行 CRC16 计算，计算的结果始终在 0-16383 之间
2. 对客户端的key进行CRC16算法计算时，同一个key经过多次计算，计算结果始终一致。
3. 对客户端的不同的key进行CRC16计算，会出现不同的key计算结果一致。

### 伪集群搭建配置文件示例

搭建 redis 伪集群实现 session 共享：
修改不同端口的配置文件：

```bash{.line-numbers}
# 启动端口号
port 7000
# 允许远程连接
bind 0.0.0.0
# rdb 方式持久化数据的文件名
dbfilename dump-7000.rdb
# 开启守护进程(即后台运行)
daemonize yes
# 开启 aof 缓存并指定 aof 方式持久化数据的文件名
appendonly yes
appendonlyfilename "appendonly-7000.aof"
# 开启集群配置
cluster-enabled yes
# 配置集群节点名称
cluster-config-file nodes-7000.conf
# 集群超时时间 5s
cluster-node-timeout 5000
```

配置主从数据库后使用 redis-cli 进行连接后，使用 `info replication` 命令查看当前数据库的 role，“master” 是主节点，“slave” 是从节点。默认从库是只读的，不能进行写操作。
